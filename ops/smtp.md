# Стварыце свой уласны сервер адпраўкі пошты SMTP

## прэамбула

SMTP можа наўпрост купляць паслугі ў воблачных пастаўшчыкоў, напрыклад:

* [Amazon SES SMTP](https://docs.aws.amazon.com/ses/latest/dg/send-email-smtp.html)
* [Алі воблачная электронная пошта](https://www.alibabacloud.com/help/directmail/latest/three-mail-sending-methods)

Вы таксама можаце стварыць свой уласны паштовы сервер - неабмежаваная адпраўка, нізкі агульны кошт.

Ніжэй мы крок за крокам дэманструем, як стварыць уласны паштовы сервер.

## Выбар сервера

Для ўласнага сервера SMTP патрабуецца публічны IP з адкрытымі партамі 25, 456 і 587.

Звычайна выкарыстоўваюцца публічныя воблакі заблакавалі гэтыя парты па змаўчанні, і іх можна адкрыць, выдаўшы працоўны заказ, але ў рэшце рэшт гэта вельмі клапотна.

Я рэкамендую купляць у хоста, у якога гэтыя парты адкрыты і падтрымлівае наладжванне зваротных даменных імёнаў.

Тут я рэкамендую [Contabo](https://contabo.com) .

Contabo - хостынг-правайдэр, які базуецца ў Мюнхене, Германія, заснаваны ў 2003 годзе і мае вельмі канкурэнтаздольныя цэны.

Калі вы вылучыце ў якасці валюты пакупкі еўра, цана будзе танней (сервер з 8 ГБ памяці і 4 працэсарамі каштуе каля 529 юаняў у год, а першапачатковая плата за ўстаноўку бясплатная на працягу аднаго года).

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/UoAQkwY.webp)

Пры размяшчэнні замовы адзначце `prefer AMD` , і сервер з працэсарам AMD будзе мець лепшую прадукцыйнасць.

У наступным я вазьму VPS Contabo ў якасці прыкладу, каб прадэманстраваць, як стварыць свой уласны паштовы сервер.

## Канфігурацыя сістэмы Ubuntu

Аперацыйная сістэма тут Ubuntu 22.04

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/smpIu1F.webp)

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/m7Mwjwr.webp)

Калі сервер на ssh адлюстроўвае `Welcome to TinyCore 13!` (як паказана на малюнку ніжэй), гэта азначае, што сістэма яшчэ не ўстаноўлена. Адключыце ssh і пачакайце некалькі хвілін, каб увайсці зноў.

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/-qKACz9.webp)

Калі з'явіцца `Welcome to Ubuntu 22.04.1 LTS` , ініцыялізацыя завершана, і вы можаце працягнуць наступныя дзеянні.

### [Дадаткова] Ініцыялізаваць асяроддзе распрацоўкі

Гэты крок неабавязковы.

Для зручнасці я змясціў усталяванне і канфігурацыю сістэмы праграмнага забеспячэння ubuntu на [github.com/wactax/ops.os/tree/main/ubuntu](https://github.com/wactax/ops.os/tree/main/ubuntu) .

Выканайце наступную каманду, каб усталяваць у адзін клік.

```
bash <(curl -s https://raw.githubusercontent.com/wactax/ops.os/main/ubuntu/boot.sh)
```

Кітайскія карыстальнікі, выкарыстоўвайце замест гэтага наступную каманду, і мова, гадзінны пояс і г.д. будуць устаноўлены аўтаматычна.

```
CN=1 bash <(curl -s https://ghproxy.com/https://raw.githubusercontent.com/wactax/ops.os/main/ubuntu/boot.sh)
```

### Contabo дазваляе IPV6

Уключыце IPV6, каб SMTP таксама мог адпраўляць электронныя лісты з адрасамі IPV6.

рэдагаваць `/etc/sysctl.conf`

Змяніце або дадайце наступныя радкі

```
net.ipv6.conf.all.disable_ipv6 = 0
net.ipv6.conf.default.disable_ipv6 = 0
net.ipv6.conf.lo.disable_ipv6 = 0
```

Працягвайце [інструкцыю contabo: Даданне падключэння IPv6 да вашага сервера](https://contabo.com/blog/adding-ipv6-connectivity-to-your-server/)

Адрэдагуйце `/etc/netplan/01-netcfg.yaml` , дадайце некалькі радкоў, як паказана на малюнку ніжэй (канфігурацыйны файл Contabo VPS па змаўчанні ўжо змяшчае гэтыя радкі, проста раскаментуйце іх).

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/5MEi41I.webp)

Затым `netplan apply` , каб змененая канфігурацыя ўступіла ў сілу.

Пасля паспяховай канфігурацыі вы можаце выкарыстоўваць `curl 6.ipw.cn` для прагляду ipv6-адраса вашай знешняй сеткі.

## Кланіраваць ops сховішча канфігурацыі

```
git clone https://github.com/wactax/ops.soft.git
```

## Стварыце бясплатны сертыфікат SSL для вашага даменнага імя

Для адпраўкі пошты патрабуецца сертыфікат SSL для шыфравання і подпісу.

Мы выкарыстоўваем [acme.sh](https://github.com/acmesh-official/acme.sh) для стварэння сертыфікатаў.

acme.sh - аўтаматызаваны інструмент подпісу сертыфікатаў з адкрытым зыходным кодам,

Увайдзіце ў сховішча канфігурацыі ops.soft, запусціце `./ssl.sh` , і папка `conf` будзе створана ў **верхнім каталогу** .

Знайдзіце свайго DNS-правайдэра ў [acme.sh dnsapi](https://github.com/acmesh-official/acme.sh/wiki/dnsapi) , адрэдагуйце `conf/conf.sh` .

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/Qjq1C1i.webp)

Затым запусціце `./ssl.sh 123.com` для стварэння сертыфікатаў `123.com` і `*.123.com` для вашага даменнага імя.

Першы запуск аўтаматычна ўсталюе [acme.sh](https://github.com/acmesh-official/acme.sh) і дадасць запланаванае заданне для аўтаматычнага абнаўлення. Вы можаце ўбачыць `crontab -l` , ёсць такі радок наступным чынам.

```
52 0 * * * "/mnt/www/.acme.sh"/acme.sh --cron --home "/mnt/www/.acme.sh" > /dev/null
```

Шлях для згенераванага сертыфіката - нешта накшталт `/mnt/www/.acme.sh/123.com_ecc。`

Абнаўленне сертыфіката выкліча сцэнар `conf/reload/123.com.sh` , адрэдагуйце гэты сцэнар, вы можаце дадаць такія каманды, як `nginx -s reload` , каб абнавіць кэш сертыфікатаў звязаных прыкладанняў.

## Стварыце сервер SMTP з дапамогай chasquid

[chasquid](https://github.com/albertito/chasquid) - гэта SMTP-сервер з адкрытым зыходным кодам, напісаны на мове Go.

У якасці замены для старажытных праграм паштовага сервера, такіх як Postfix і Sendmail, chasquid больш просты і лёгкі ў выкарыстанні, а таксама яго лягчэй для другаснай распрацоўкі.

Запусціце `./chasquid/init.sh 123.com` будзе ўсталяваны аўтаматычна ў адзін клік (заменіце 123.com даменным імем адпраўкі).

## Наладзьце подпіс электроннай пошты DKIM

DKIM выкарыстоўваецца для адпраўкі подпісаў электроннай пошты, каб прадухіліць расцэньванне лістоў як спаму.

Пасля паспяховага выканання каманды вам будзе прапанавана ўсталяваць запіс DKIM (як паказана ніжэй).

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/LJWGsmI.webp)

Проста дадайце запіс TXT у свой DNS (як паказана ніжэй).

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/0szKWqV.webp)

## Прагляд стану абслугоўвання і часопісаў

 `systemctl status chasquid` Прагляд стану службы.

Стан нармальнай працы, як паказана на малюнку ніжэй

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/CAwyY4E.webp)

 `grep chasquid /var/log/syslog` або `journalctl -xeu chasquid` можа праглядаць журнал памылак.

## Зваротная канфігурацыя даменнага імя

Адваротнае даменнае імя дазваляе пераўтварыць IP-адрас у адпаведнае даменнае імя.

Усталяванне зваротнага даменнага імя можа прадухіліць ідэнтыфікацыю электронных лістоў як спаму.

Калі пошта атрымана, які прымае сервер будзе выконваць зваротны аналіз даменнага імя на IP-адрасе сервера-адпраўшчыка, каб пацвердзіць, ці мае сервер-адпраўшчык сапраўднае зваротнае даменнае імя.

Калі сервер-адпраўшчык не мае зваротнага даменнага імя або калі зваротнае даменнае імя не супадае з IP-адрасам сервера-адпраўшчыка, сервер-адпраўшчык можа распазнаць ліст як спам або адхіліць яго.

Наведайце [https://my.contabo.com/rdns](https://my.contabo.com/rdns) і наладзьце, як паказана ніжэй

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/IIPdBk_.webp)

Пасля ўстаноўкі зваротнага даменнага імя не забудзьцеся наладзіць прамое дазвол даменных імёнаў ipv4 і ipv6 на сервер.

## Адрэдагуйце імя хаста chasquid.conf

Змяніце `conf/chasquid/chasquid.conf` да значэння адваротнага даменнага імя.

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/6Fw4SQi.webp)

Затым запусціце `systemctl restart chasquid` , каб перазапусціць службу.

## Рэзервовае капіраванне conf у рэпазітар git

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/Fier9uv.webp)

Напрыклад, я раблю рэзервовую копію тэчкі conf у свой уласны працэс github наступным чынам

Спачатку стварыце прыватны склад

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/ZSCT1t1.webp)

Увайдзіце ў каталог conf і адпраўце на склад

```
git init
git add .
git commit -m "init"
git branch -M main
git remote add origin git@github.com:wac-tax-key/conf.git
git push -u origin main
```

## Дадаць адпраўніка

бегчы

```
chasquid-util user-add i@wac.tax
```

Можна дадаць адпраўніка

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/khHjLof.webp)

### Пераканайцеся, што пароль усталяваны правільна

```
chasquid-util authenticate i@wac.tax --password=xxxxxxx
```

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/e92JHXq.webp)

Пасля дадання карыстальніка `chasquid/domains/wac.tax/users` будзе абноўлены, не забудзьце адправіць яго на склад.

## DNS дадаць запіс SPF

SPF (Sender Policy Framework) - гэта тэхналогія праверкі электроннай пошты, якая выкарыстоўваецца для прадухілення махлярства электроннай пошты.

Ён правярае асобу адпраўніка пошты, правяраючы, што IP-адрас адпраўніка супадае з запісамі DNS даменнага імя, за якое ён сябе выдае, што прадухіляе ашуканцаў ад адпраўкі фальшывых лістоў.

Даданне запісаў SPF можа максімальна прадухіліць вызначэнне электроннай пошты як спаму.

Калі ваш сервер даменных імёнаў не падтрымлівае тып SPF, проста дадайце запіс тыпу TXT.

Напрыклад, SPF `wac.tax` выглядае наступным чынам

`v=spf1 a mx include:_spf.wac.tax include:_spf.google.com ~all`

SPF для `_spf.wac.tax`

`v=spf1 a:smtp.wac.tax ~all`

Звярніце ўвагу, што тут у мяне ёсць `include:_spf.google.com` , таму што пазней я наладжу `i@wac.tax` у якасці адраса адпраўкі ў паштовай скрыні Google.

## Канфігурацыя DNS DMARC

DMARC - гэта абрэвіятура (праверка сапраўднасці паведамленняў на аснове дамена, справаздачнасць і адпаведнасць).

Ён выкарыстоўваецца для фіксацыі адмоў SPF (магчыма, выкліканых памылкамі канфігурацыі, або нехта іншы прыкідваецца вамі, каб рассылаць спам).

Дадаць запіс TXT `_dmarc` ,

Змест такі

```
v=DMARC1; p=quarantine; fo=1; ruf=mailto:ruf@wac.tax; rua=mailto:rua@wac.tax
```

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/k44P7O3.webp)

Значэнне кожнага параметру наступнае

### p (Палітыка)

Паказвае, як апрацоўваць электронныя лісты, якія не прайшлі праверку SPF (Sender Policy Framework) або DKIM (DomainKeys Identified Mail). Параметр p можа мець адно з трох значэнняў:

* none: ніякіх дзеянняў не прадпрымаецца, толькі вынік праверкі вяртаецца адпраўніку праз механізм паведамлення па электроннай пошце.
* Каранцін: змесціце ліст, які не прайшоў праверку, у тэчку са спамам, але не будзе адхіляць ліст непасрэдна.
* адхіліць: Непасрэдна адхіляць электронныя лісты, якія не прайшлі праверку.

### fo (параметры няўдач)

Вызначае аб'ём інфармацыі, які вяртаецца механізмам справаздачнасці. Яму можна задаць адно з наступных значэнняў:

* 0: справаздача аб выніках праверкі для ўсіх паведамленняў
* 1: паведамляць толькі пра паведамленні, якія не прайшлі праверку
* d: паведамляць толькі пра памылкі праверкі даменнага імя
* s: паведамляць толькі аб збоях праверкі SPF
* l: паведамляць толькі аб збоях праверкі DKIM

### руа і руф

* rua (URI справаздач для зводных справаздач): адрас электроннай пошты для атрымання зводных справаздач
* ruf (URI справаздачнасці для крыміналістычных справаздач): адрас электроннай пошты для атрымання падрабязных справаздач

## Дадайце запісы MX для перасылкі электронных лістоў у Google Mail

Паколькі я не мог знайсці бясплатную карпаратыўную паштовую скрыню, якая падтрымлівае ўніверсальныя адрасы (Catch-All, можа атрымліваць любыя электронныя лісты, адпраўленыя на гэтае даменнае імя, без абмежаванняў на прэфіксы), я выкарыстаў chasquid для перанакіравання ўсіх лістоў у маю паштовую скрыню Gmail.

**Калі ў вас ёсць уласны платны службовы паштовую скрыню, калі ласка, не змяняйце MX і прапусціце гэты крок.**

Рэдагаваць `conf/chasquid/domains/wac.tax/aliases` , усталяваць паштовую скрыню пераадрасацыі

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/OBDl2gw.webp)

`*` паказвае ўсе электронныя лісты, `i` - прэфікс адраса электроннай пошты карыстальніка-адпраўшчыка, створанага вышэй. Для перасылкі пошты кожны карыстальнік павінен дадаць радок.

Затым дадайце запіс MX (я паказваю непасрэдна на адрас зваротнага даменнага імя тут, як паказана ў першым радку на малюнку ніжэй).

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/7__KrU8.webp)

Пасля завяршэння канфігурацыі вы можаце выкарыстоўваць іншыя адрасы электроннай пошты для адпраўкі электронных лістоў на `i@wac.tax` і `any123@wac.tax` , каб даведацца, ці можаце вы атрымліваць электронныя лісты ў Gmail.

Калі няма, праверце журнал chasquid ( `grep chasquid /var/log/syslog` ).

## Адпраўце электронны ліст на i@wac.tax праз Google Mail

Пасля таго як Google Mail атрымала ліст, я, натуральна, спадзяваўся адказаць `i@wac.tax` замест i.wac.tax@gmail.com.

Наведайце [https://mail.google.com/mail/u/1/#settings/accounts](https://mail.google.com/mail/u/1/#settings/accounts) і націсніце «Дадаць іншы адрас электроннай пошты».

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/PAvyE3C.webp)

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/_OgLsPT.webp)

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/XIUf6Dc.webp)

Затым увядзіце код пацверджання, атрыманы па электроннай пошце, на якую была пераслана.

Нарэшце, яго можна ўсталяваць у якасці адраса адпраўніка па змаўчанні (разам з магчымасцю адказаць з тым жа адрасам).

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/a95dO60.webp)

Такім чынам, мы завяршылі стварэнне паштовага сервера SMTP і ў той жа час выкарыстоўваем Google Mail для адпраўкі і атрымання лістоў.

## Адпраўце тэставы электронны ліст, каб праверыць, ці паспяховая канфігурацыя

Увядзіце `ops/chasquid`

Запусціце `direnv allow` , каб усталяваць залежнасці (direnv быў усталяваны ў папярэднім працэсе ініцыялізацыі адной клавішай, і ў абалонку быў дададзены хук)

потым бегчы

```
user=i@wac.tax pass=xxxx to=iuser.link@gmail.com ./sendmail.coffee
```

Сэнс параметраў наступны

* карыстальнік: імя карыстальніка SMTP
* pass: пароль SMTP
* каму: атрымальнік

Вы можаце адправіць тэставы ліст.

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/ae1iWyM.webp)

Рэкамендуецца выкарыстоўваць Gmail для атрымання тэставых электронных лістоў, каб праверыць, ці паспяхова выкананы канфігурацыі.

### Стандартнае шыфраванне TLS

Як паказана на малюнку ніжэй, ёсць гэты маленькі замак, які азначае, што сертыфікат SSL быў паспяхова ўключаны.

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/SrdbAwh.webp)

Затым націсніце «Паказаць зыходны ліст»

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/qQQsdxg.webp)

### DKIM

Як паказана на малюнку ніжэй, зыходная старонка пошты Gmail адлюстроўвае DKIM, што азначае, што канфігурацыя DKIM прайшла паспяхова.

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/an6aXK6.webp)

Праверце Received у загалоўку арыгінальнага электроннага ліста, і вы ўбачыце, што адрас адпраўніка IPV6, што азначае, што IPV6 таксама паспяхова наладжаны.
